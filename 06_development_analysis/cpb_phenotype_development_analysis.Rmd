---
ttitle: "Analysis 6: Development analysis"
author: "Joe Gunn"
date: "2024-09-19"
output: html_document
---

# <b>Project:</b> Assessing phenotypic response and transgenerational inheritance following insecticide exposure in Colorado Potato Beetles (<i>Leptinotarsa decemlineata</i>; CPB) 
<font size="+1"> We assessed inter- and trans-generational effects of sublethal insecticide exposure on four larval performance phenotypes (fecundity, herbivory, mobility, and development) in Colorado potato beetles (<i>Leptinotarsa decemlineata</i>; CPB). We implemented a replicated inbred full-sibling pedigree design, beginning with 12 "founder" mated pair lineages and continuing for four successive generations (full siblings within lineages were inbred in each generation). For the transgenerational experiment, F<sub>0</sub> larvae (offspring of founder pairs) were divided into two "background" groups (exposed, i.e., exposed to a sub-lethal [10-ppm] dose of the neonicotinoid insecticide imidacloprid; and control, i.e., exposed to an equivalent dose of molecular-grade water). All mated pair beetles across lineages, treatments, and generations were monitored for daily fecundity. A subset of third instar larvae were collected from each treatment within each lineage for each generation and monitored for three  performance traits, including larval movement (mobility), feeding rate (herbivory), and time to discrete life stages (development). Performance traits were monitored in three successive generations (F<sub>1</sub>-F<sub>3</sub>) without treatment exposure and compared to the F<sub>0</sub> generation to test for inter- and transgenerationally-inherited "memory" of phenotypic variation. An additional subset of larvae from each generation were re-exposed to the treatments, both experimental (insecticide-exposed) and control (water), to test for potential inheritance of a phenotypic "response" to insecticide stress.</font>

# <b>Specific Aim:</b> Development analysis
<font size="+1">In this analysis, we assess differences in larval development (i.e., time to pupation, time from pupae to adult emergence, pupal mass, and adult mass) among mated pairs in the transgenerational experiment by generation (i.e., F0, F1, F2, F3), lineage (i.e., L1, L2, ... L10), and treatment (i.e., control and exposed). </font>

## Phases of Analysis
### Phase 1: Data summary statistics
### Phase 2: Development analysis

### Libraries needed for analysis
```{r}
library(tidyverse)
library(cowplot)
library(readxl)
library(writexl)
library(rstatix)
library(lme4)
library(rsq)
library(car)
library(scales)
library(fitdistrplus)
library(forcats)
library(patchwork)
library(emmeans)
```

## PHASE 1: DATA SUMMARY STATISTICS
In this phase of the analysis, we calculate mean, standard deviation, and variance for all metrics (including also pupal mass and adult mass) within experimental groups of interest.

### STEP 1: Calculate summary statistics for larval development data; run the Rmd chunk below.
In this step, we calculate mean, standard deviation, and variance for larval development metrics (i.e., time to pupation, pupation duration, pupal mass, and adult mass) for all experimental groups.

##### Calculate summary statistics for larval development data:
```{r}
# load pupa mass data
load("data/pupa_mass.Rda")

# load pupa time data
load("data/pupa_time.Rda")

# load pupa duration data
load("data/pupa_duration.Rda")

# get sample size (n), mean, standard deviation (sd), and standard error (se) for pupation duration by generation and treatment
pupa_mass %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(pupa_mass),
            sd = sd(pupa_mass),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for time to pupation by generation and treatment
pupa_time %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(pupa_time),
            sd = sd(pupa_time),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for pupation duration by generation and treatment
pupa_duration %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(pupa_duration),
            sd = sd(pupa_duration),
            se = sd/sqrt(n()))
```

These data are presented in Table 1d of the final ms.

## PHASE 2: DEVELOPMENT ANALYSIS
In this phase of the analysis, we assess differences in larval development metrics (i.e., pupal mass, time to pupation, and duration of pupation) between treatments and background exposure statuses across generations, accounting for variation in lineages as a random effect in a general linear mixed-effect model framework. We assess two distinct modes of potential phenotypic effects: 1) assessing inheritance of phenotypic "memory" of stress by comparing phenotypic variation (i.e., development metrics) in beetles with a background (F0 exposure) of insecticide vs. those with a background of the water control and without subsequent exposure in successive generations; and 2) assessing inheritance of a phenotypic "response" to stress by comparing phenotypic variation (i.e., development metrics) in beetles treated in each generation with insecticide or a water control and which had a background (F0 exposure) of either insecticide or the water control. 

### STEP 1: Analyze pupa mass data.

#### 1a: Test fit of empirical pupa mass data to a normal distribution; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether pupa mass in each group of interest deviate from a normal distribution.

##### Test fit of normality for pupa mass data:
```{r}
# load pupa mass data
load("data/pupa_mass.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
pupa_mass %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(pupa_mass) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
F0_C_N: p = 0.57285112 <br>
F0_E_N: p = 0.57285112 <br>
F1_C_N: p = 0.24765605 <br>
F1_C_R: p = 0.95436038 <br>
F1_E_N: p = 0.34897630 <br>
F1_E_R: p = 0.68958051 <br>
F2_C_N: p = 0.14922714 <br>
F2_C_R: p = 0.23095331 <br>
F2_E_N: p = 0.52693347 <br>
F2_E_R: p = 0.75231724 <br>
F3_C_N: p = 0.15918717 <br>
F3_C_R: p = 0.15079756 <br>
F3_E_N: p = 0.19817161 <br>
F3_E_R: p = 0.04852424 <br>

Since no tests indicate a deviation from a normal distribution (p < 0.003), we assume these data are best fit by a normal distribution for the data across groups of interest.

#### 1b: Plot empirical data distribution; run the Rmd chunk below.

##### Plot empirical data distribution for pupa mass: `figures/mass_distribution.jpeg`
```{r}
# load pupa mass data
load("data/pupa_mass.Rda")

# plot distribution
jpeg("figures/pupa_mass_distribution.jpeg", width = 5000, height = 4000, res = 500)

ggplot(pupa_mass, aes(x = pupa_mass)) +
  geom_histogram(binwidth = 5, color = "black", fill = "grey", linewidth = 1) +
  theme_set(theme_cowplot(12)) +
  scale_x_continuous(breaks = seq(from = 0, to = 180, by = 20), 
                     limits = c(0,180)) +
  scale_y_continuous(breaks = seq(from = 0, to = 25, by = 5), 
                     limits = c(0,25)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  xlab("Pupa mass (mg)") +
  ylab("Frequency") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

This figure is presented as Figure XXX in the final ms.

#### 1c: Run two-factor linear mixed effect interaction models assuming a normal distribution to test the relative effects of background and treatment of insecticide stress on pupa mass; run the Rmd chunk below.
In this step, we run linear mixed effect interaction models with raw pupa mass as a response, interacting fixed effects of background and treatment, and lineage as a random effect. We assume an underlying normal distribution for the data (see Step 1b above).

##### Run linear mixed effect interaction models for pupa mass:
```{r}
# load pupa mass data
load("data/pupa_mass.Rda")

# isolate only F0 data
f0 <- pupa_mass %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_mass %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_mass %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_mass %>%
  filter(larval_generation == "F3")

# f0 linear mixed effect model
f0_mod <- lmer(pupa_mass ~ background + (1|lineage),
               data = f0)

# f1 linear mixed effect model
f1_mod <- lmer(pupa_mass ~ treatment*background + (1|lineage),
               data = f1)

# f2 linear mixed effect model
f2_mod <- lmer(pupa_mass ~ treatment*background + (1|lineage),
               data = f2)

# f2 linear mixed effect model
f3_mod <- lmer(pupa_mass ~ treatment*background + (1|lineage),
               data = f3)

# summarize f0 model
anova(f0_mod) # get F value
Anova(f0_mod) # get p value
emmeans(f0_mod, poly ~ background) # get marginal means and pairwise contrasts
df.residual(f0_mod) # get degrees of freedom

# summarize f1 model
anova(f1_mod) # get F value
Anova(f1_mod) # get p values
emmeans(f1_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f1_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f1_mod) # get degrees of freedom

# summarize f2 model
anova(f2_mod) # get F values
Anova(f2_mod) # get p values
emmeans(f2_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f2_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f2_mod) # get degrees of freedom

# summarize f3 model
anova(f3_mod) # get F values
Anova(f3_mod) # get p values
emmeans(f3_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f3_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f3_mod) # get degrees of freedom
```

<b>Analysis results:</b> <br>

<b>Coefficients of zero-inflated logistic regressions by generation:</b><br>
<b>F0</b>: <br>
Background: F = 0.7394; p = 0.3899 <br>
d.f. = 105 <br>

<b>F1</b>: <br>
Treatment: F = 0.1494; p = 0.6762 <br>
Background: F = 0.0866; p = 0.7685 <br>
Treatment x Background : F = 0.0899; p = 0.7643 <br>
d.f. = 72 <br>

<b>F2</b>: <br>
Treatment: F = 0.7263; p = 0.3707 <br>
Background: F = 2.3075; p = 0.1288 <br>
Treatment x Background: F = 0.0365; p = 0.8484 <br>
d.f. = 50 <br>

<b>F3</b>: <br>
Treatment: F = 1.4471; p = 0.2138 <br>
Background: F = 0.1892; p = 0.6635 <br>
Treatment x Background: F = 0.0357; p = 0.8502 <br>
d.f. = 40 <br>

These data are presented in Table XXX of the final ms.

#### 1d: Plot mean pupa mass data; run the Rmd chunk below.

##### Plot mean data: `figures/pupa_mass_means.jpeg`
```{r}
# load pupa mass data
load("data/pupa_mass.Rda")

# get sample size (n), mean or proportion, standard deviation (sd), and standard error (se) for herbivory by generation, background, and treatment for plotting
pupa_mass <- pupa_mass %>%
  group_by(larval_generation, background, treatment) %>%
  summarize(mean = mean(pupa_mass),
            sd = sd(pupa_mass),
            n = n(),
            se = sd/sqrt(n))

# isolate only F0 data
f0 <- pupa_mass %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_mass %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_mass %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_mass %>%
  filter(larval_generation == "F3")

# plot f0 data
f0_plot <- ggplot(f0, aes(x = background, y = mean, group = background, color = background)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
   geom_point(aes(x = background, y = mean, group = background, fill = background), 
              position = position_dodge(width = 0.4), 
              size = 7, 
              pch = 22, 
              stroke = 2, 
              color = "black", 
              show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 30),
                     limits = c(0,150)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  labs(x = "Original exposure", y = "Pupa mass (mg)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f1 data
f1_plot <- ggplot(f1, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 30),
                     limits = c(0,150)) +
  theme(axis.title = element_text(size = 30)) +
  theme(axis.text = element_text(size = 30)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  #theme(legend.text = element_text(size = 30)) +
  #theme(legend.title = element_text(size = 30, face = "bold")) +
  #theme(legend.key.size = unit(2, 'cm')) +
  #theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  #theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  #theme(legend.box.margin = margin(5, 10, 1, 10)) +
  #theme(legend.position = c(0.05,0.2)) + 
  labs(x = "Treatment", y = "Pupa mass (mg)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f2 data
f2_plot <- ggplot(f2, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 30),
                     limits = c(0,150)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment", y = "Pupa mass (mg)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f3 data
f3_plot <- ggplot(f3, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background),
             position = position_dodge(width = 0.4), 
             size = 7,
             pch = 22,
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 30),
                     limits = c(0,140)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment",  y = "Pupa mass (mg)")+
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot all pupa mass figures together
jpeg("figures/pupa_mass_means.jpeg", width = 20000, height = 4000, res = 1000)

f0_plot + f1_plot +  f2_plot + f3_plot + plot_layout(nrow = 1, ncol = 4)

dev.off()
```

### STEP 2: Analyze pupa time data.

#### 2a: Test fit of normal distribution for pupa time data; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether pupa time in each group of interest deviate from a normal distribution.

##### Test fit of normality for pupa time data:
```{r}
# load pupa time data
load("data/pupa_time.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
pupa_time %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(pupa_time) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
F0_C_N: <b>p < 0.001</b><br>
F0_E_N: <b>p < 0.001</b><br>
F1_C_N: <b>p = 0.002</b><br>
F1_C_R: p = 0.28535583147003<br>
F1_E_N: p = 0.33676670438883<br>
F1_E_R: <b>p < 0.001</b><br>
F2_C_N: <b>p < 0.001</b><br>
F2_C_R: <b>p < 0.001</b><br>
F2_E_N: <b>p < 0.001</b><br>
F2_E_R: p = 0.55785036394542<br>
F3_C_N: <b>p < 0.001</b><br>
F3_C_R: <b>p < 0.001</b><br>
F3_E_N: p = 0.15940225860021<br>
F3_E_R: p = 0.43241127674505<br>

Since 9/14 tests indicate a deviation from a normal distribution (p < 0.003), we test the fit of multiple alternative distributions to determine whether there is consistent best-fitting distribution for the data across groups of interest.

#### 2b: Test fit of empirical data to alternative distributions; run the Rmd chunk below.
In this step, we plot the raw data distribution and test the fit of four potential distributions that commonly underlie count data (i.e., normal, log-normal, poisson, and negative binomial), and determine the best fitting distribution for each group of interest.

##### Test fit of alternative distributions:
```{r}
# load pupa time data
load("data/pupa_time.Rda")

# Generate combined "group" factor, which includes larval generation, background, and treatment, to test distributions within each group of interest.
pupa_time <- pupa_time %>%
  unite(group, larval_generation, c(background, treatment), sep = "_", remove = F) %>%
  mutate(group = factor(group))

# generate list of levels within group factor
levels <- levels(pupa_time$group)

# define empty lists to hold statistics for each distribution test
unif <- list()
norm <- list()
lnor <- list()
gamm <- list()


# Write for loop to fit each distribution to data, iterating through group levels (i)
for(i in levels) {
  
  # generate subsets of data for each group level
  subset <- pupa_time[pupa_time$group == i, ]
  
  # fit distributions to leaf area for each subset
  fit_unif <- fitdist(subset$pupa_time, "unif") 
  fit_norm <- fitdist(subset$pupa_time, "norm") 
  fit_lnor <- fitdist(subset$pupa_time, "lnorm")
  fit_gamm <- fitdist(subset$pupa_time, "gamma") 
  
  # fill list with fit results for each distribution
  unif[[i]] <- fit_unif
  norm[[i]] <- fit_norm
  lnor[[i]] <- fit_lnor
  gamm[[i]] <- fit_gamm
  
}

# Get table of distribution stats for F0 C N group
stats_1 <- data_frame(F0_C_N = gofstat(list(unif$F0_C_N,
                                            norm$F0_C_N,
                                            lnor$F0_C_N, 
                                            gamm$F0_C_N))$aic)

# Get table of distribution stats for F0 E N group
stats_2 <- data_frame(F0_E_N = gofstat(list(unif$F0_E_N,
                                            norm$F0_E_N,
                                            lnor$F0_E_N, 
                                            gamm$F0_E_N))$aic)

# Get table of distribution stats for F1 C N group
stats_3 <- data_frame(F1_C_N = gofstat(list(unif$F1_C_N,
                                            norm$F1_C_N,
                                            lnor$F1_C_N, 
                                            gamm$F1_C_N))$aic)

# Get table of distribution stats for F1 C R group
stats_4 <- data_frame(F1_C_R = gofstat(list(unif$F1_C_R, 
                                            norm$F1_C_R,
                                            lnor$F1_C_R, 
                                            gamm$F1_C_R))$aic)

# Get table of distribution stats for F1 E N group
stats_5 <- data_frame(F1_E_N = gofstat(list(unif$F1_E_N, 
                                            norm$F1_E_N,
                                            lnor$F1_E_N,
                                            gamm$F1_E_N))$aic)

# Get table of distribution stats for F1 E R group
stats_6 <- data_frame(F1_E_R = gofstat(list(unif$F1_E_R, 
                                            norm$F1_E_R,
                                            lnor$F1_E_R,
                                            gamm$F1_E_R))$aic)

# Get table of distribution stats for F2 C N group
stats_7 <- data_frame(F2_C_N = gofstat(list(unif$F2_C_N, 
                                            norm$F2_C_N,
                                            lnor$F2_C_N,
                                            gamm$F2_C_N))$aic)

# Get table of distribution stats for F2 C R group
stats_8 <- data_frame(F2_C_R = gofstat(list(unif$F2_C_R, 
                                            norm$F2_C_R,
                                            lnor$F2_C_R,
                                            gamm$F2_C_R))$aic)

# Get table of distribution stats for F2 E N group
stats_9 <- data_frame(F2_E_N = gofstat(list(unif$F2_E_N, 
                                            norm$F2_E_N,
                                            lnor$F2_E_N,
                                            gamm$F2_E_N))$aic)

# Get table of distribution stats for F2 E R group
stats_10 <- data_frame(F2_E_R = gofstat(list(unif$F2_E_R, 
                                             norm$F2_E_R,
                                             lnor$F2_E_R,
                                             gamm$F2_E_R))$aic)

# Get table of distribution stats for F3 C N group
stats_11 <- data_frame(F3_C_N = gofstat(list(unif$F3_C_N, 
                                             norm$F3_C_N,
                                             lnor$F3_C_N,
                                             gamm$F3_C_N))$aic)

# Get table of distribution stats for F3 C R group
stats_12 <- data_frame(F3_C_R = gofstat(list(unif$F3_C_R, 
                                             norm$F3_C_R,
                                             lnor$F3_C_R,
                                             gamm$F3_C_R))$aic)

# Get table of distribution stats for F3 E N group
stats_13 <- data_frame(F3_E_N = gofstat(list(unif$F3_E_N, 
                                             norm$F3_E_N,
                                             lnor$F3_E_N,
                                             gamm$F3_E_N))$aic)

# Get table of distribution stats for F3 E R group
stats_14 <- data_frame(F3_E_R = gofstat(list(unif$F3_E_R,
                                             norm$F3_E_R,
                                             lnor$F3_E_R,
                                             gamm$F3_E_R))$aic)

# combine all stats into a single table and add a first column with the name of the distribution being tested
stats <- cbind(distribution = c("uniform", "normal", "log-normal", "gamma"), 
               stats_1, 
               stats_2, 
               stats_3, 
               stats_4,
               stats_5, 
               stats_6, 
               stats_7,
               stats_8, 
               stats_9, 
               stats_10, 
               stats_11, 
               stats_12, 
               stats_13, 
               stats_14)

# Run global distribution to test if gamma is best fitting

# Run individual global distributions 
unif <- fitdist(pupa_time$pupa_time, "unif")
norm <- fitdist(pupa_time$pupa_time, "norm")
lnor <- fitdist(pupa_time$pupa_time, "lnorm")
gamm <- fitdist(pupa_time$pupa_time, "gamma")

# compare AIC values 
gofstat(list(unif, 
             norm,
             lnor,
             gamm),
        fitnames = c("uniform",
                     "normal",
                     "log-normal",
                     "gamma"))$aic
```

<b>Analysis results:</b> <br>

| Group     | Uniform          | Normal           | Log-normal       | Gamma             | 
|:----------|:-----------------|:-----------------|:-----------------| :-----------------|
| F0_C_N    | 264.752          | 234.457          | <b>229.903</b>   | 231.115           |
| F0_E_N    | 219.456          | 181.659          | <b>165.241</b>   | 170.118           | 
| F1_C_N    | 113.861          | 115.414          | <b>111.138</b>   | 112.389           | 
| F1_C_R    | <b>50.590</b>    | 57.536           | 56.858           | 57.032            | 
| F1_E_N    | <b>86.421</b>    | 87.528           | 87.341           | 87.308            | 
| F1_E_R    | 113.603          | 108.894          | <b>97.768</b>    | 101.056           | 
| F2_C_N    | 115.889          | 113.515          | <b>101.458</b>   | 105.114           |
| F2_C_R    | <b>20.636</b>    | 26.721           | 27.762           | 27.409            |
| F2_E_N    | 79.825           | 79.306           | <b>73.796</b>    | 79.825            | 
| F2_E_R    | <b>39.408</b>    | 43.631           | 43.504           | 43.511            |
| F3_C_N    | <b>50.586</b>    | 59.662           | 57.093           | 57.093            |
| F3_C_R    | <b>46.810</b>    | 53.436           | 50.846           | 51.661            |
| F3_E_N    | <b>52.283</b>    | 55.048           | 54.374           | 54.545            |
| F3_E_R    | <b>23.408</b>    | 28.573           | 28.230           | 28.23025          |
| Global    | 1796.805         | 1355.923         | <b>1235.982</b>  | 1269.739          |

The data in the majority of groups were best fit to a uniform distribution. The best fitting distribution to the global data set across groups is the log-normal distribution. We opted to assume a log-normal distribution in all general linear model analyses given that it is biologically unlikely that the distribution of time to pupation follows a uniform distribution.

These data are presented as Table XXX in the final ms.

#### 2c: Plot empirical data distribution; run the Rmd chunk below.

##### Plot empirical data distribution for pupa time: `figures/pupa_time_distribution.jpeg`
```{r}
# load pupa time data
load("data/pupa_time.Rda")

# plot distribution
jpeg("figures/pupa_time_distribution.jpeg", width = 5000, height = 4000, res = 500)

ggplot(pupa_time, aes(x = pupa_time)) +
  geom_histogram(binwidth = 1, color = "black", fill = "grey", linewidth = 1) +
  theme_set(theme_cowplot(12)) +
  scale_x_continuous(breaks = seq(from = 0, to = 35, by = 5), 
                     limits = c(0,35)) +
  scale_y_continuous(breaks = seq(from = 0, to = 80, by = 10),
                     limits = c(0,80)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  xlab("Time to pupal stage (days)") +
  ylab("Frequency") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

This figure is presented as Figure XXX in the final ms.

#### 2d: Run two-factor general linear mixed effect interaction models assuming a log-normal distribution to test the relative effects of background and treatment of insecticide stress on pupa time; run the Rmd chunk below.
In this step, we run general linear mixed effect interaction models with raw time to pupation as a response, interacting fixed effects of background and treatment, and lineage as a random effect. We assume an underlying log-normal distribution for the data (see Step 2b above).

##### Run linear mixed effect interaction models for pupa time:
```{r}
# load pupa time data
load("data/pupa_time.Rda")

# isolate only F0 data
f0 <- pupa_time %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_time %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_time %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_time %>%
  filter(larval_generation == "F3")

# f0 general linear mixed effect model with log-normal distribution
f0_mod <- glmer(pupa_time ~ background + (1|lineage),
                family = gaussian(link = "log"),
                data = f0)

# f1 general linear mixed effect model with log-normal distribution
f1_mod <- glmer(pupa_time ~ treatment*background + (1|lineage),
                family = gaussian(link = "log"),
                data = f1)

# f2 general linear mixed effect model with log-normal distribution
f2_mod <- glmer(pupa_time ~ treatment*background + (1|lineage),
                family = gaussian(link = "log"),
                data = f2)

# f2 general linear mixed effect model with log-normal distribution
f3_mod <- glmer(pupa_time ~ treatment*background + (1|lineage),
                family = gaussian(link = "log"),
                data = f3)

# summarize f0 model
anova(f0_mod) # get F values
Anova(f0_mod) # get p values
emmeans(f1_mod, poly ~ background) # get marginal means and pairwise contrasts
df.residual(f0_mod) # get degrees of freedom

# summarize f1 model
anova(f1_mod) # get F values
Anova(f1_mod) # get p values
emmeans(f1_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f1_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f1_mod) # get degrees of freedom

# summarize f2 model
anova(f2_mod) # get F values
Anova(f2_mod) # get p values
emmeans(f2_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f2_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f2_mod) # get degrees of freedom

# summarize f3 model
anova(f3_mod) # get F values
Anova(f3_mod) # get p values
emmeans(f3_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f3_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f3_mod) # get degrees of freedom
```

<b>Analysis results:</b> <br>

<b>Coefficients of general linear mixed effect models by generation:</b><br>
<b>F0</b>: <br>
Background: F = 5.1734; p = 0.02294 <br>
d.f. = 105 <br>

<b>F1</b>: <br>
Treatment: F = 1.0037; p = 0.2973 <br>
Background: F = 0.1104; p = 0.7397 <br>
Treatment x Background : F = 1.7532; p = 0.1855 <br>
d.f. = 73 <br>

<b>F2</b>: <br>
Treatment: F = 1.1644; p = 0.2669 <br>
Background: F = 0.3633; p = 0.5467 <br>
Treatment x Background: F = 0.0006; p = 0.9813 <br>
d.f. = 50 <br>

<b>F3</b>: <br>
Treatment: F = 1.3714; p = 0.2926 <br>
Background: F = 0.6927; p = 0.4052 <br>
Treatment x Background: F = 0.1033; p = 0.7480 <br>
d.f. = 40 <br>

These data are presented in Table 3a in the final ms.

#### 3e: Plot mean pupa time data; run the Rmd chunk below.

##### Plot mean data: `figures/pupa_time_means.jpeg`
```{r}
# load pupa time data
load("data/pupa_time.Rda")

# get sample size (n), mean or proportion, standard deviation (sd), and standard error (se) for herbivory by generation, background, and treatment for plotting
pupa_time <- pupa_time %>%
  group_by(larval_generation, background, treatment) %>%
  summarize(mean = mean(pupa_time),
            sd = sd(pupa_time),
            n = n(),
            se = sd/sqrt(n))

# isolate only F0 data
f0 <- pupa_time %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_time %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_time %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_time %>%
  filter(larval_generation == "F3")

# plot f0 data
f0_plot <- ggplot(f0, aes(x = background, y = mean, group = background, color = background)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
   geom_point(aes(x = background, y = mean, group = background, fill = background), 
              position = position_dodge(width = 0.4), 
              size = 7, 
              pch = 22, 
              stroke = 2, 
              color = "black", 
              show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 10, to = 16, by = 1),
                     limits = c(10,16)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  labs(x = "Original exposure", y = "Time to pupation (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f1 data
f1_plot <- ggplot(f1, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 10, to = 16, by = 1),
                     limits = c(10,16)) +
  theme(axis.title = element_text(size = 30)) +
  theme(axis.text = element_text(size = 30)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  #theme(legend.text = element_text(size = 30)) +
  #theme(legend.title = element_text(size = 30, face = "bold")) +
  #theme(legend.key.size = unit(2, 'cm')) +
  #theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  #theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  #theme(legend.box.margin = margin(5, 10, 1, 10)) +
  #theme(legend.position = c(0.05,0.2)) + 
  labs(x = "Treatment", y = "Time to pupation (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f2 data
f2_plot <- ggplot(f2, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 10, to = 16, by = 1),
                     limits = c(10,16)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment", y = "Time to pupation (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f3 data
f3_plot <- ggplot(f3, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background),
             position = position_dodge(width = 0.4), 
             size = 7,
             pch = 22,
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 10, to = 16, by = 1),
                     limits = c(10,16)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment", y = "Time to pupation (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot all pupa time figures together
jpeg("figures/pupa_time_means.jpeg", width = 20000, height = 4000, res = 1000)

f0_plot + f1_plot + f2_plot + f3_plot + plot_layout(nrow = 1, ncol = 4)

dev.off()
```

### STEP 3: Analyze pupa duration data.

#### 3a: Test fit of normal distribution for pupa duration data; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether pupa duration in each group of interest deviate from a normal distribution.

##### Test fit of normality for pupa duration data:
```{r}
# load pupa duration data
load("data/pupa_duration.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
pupa_duration %>%
  filter(!(larval_generation == "F2" & background == "E" & treatment == "R")) %>% # F2_E_R individuals all have the same value, so they are removed from the dataset for analysis, and an NA is included for those data
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(pupa_duration) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
F0_C_N: <b>p < 0.001</b><br>
F0_E_N: <b>p < 0.001</b><br>
F1_C_N: <b>p < 0.001</b><br>
F1_C_R: <b>p < 0.001</b><br>
F1_E_N: <b>p < 0.001</b><br>
F1_E_R: p = 0.03656839160038597<br>
F2_C_N: <b>p < 0.001</b><br>
F2_C_R: <b>p < 0.001</b><br>
F2_E_N: <b>p < 0.001</b><br>
F2_E_R: NA<br>
F3_C_N: p < 0.01844302647991799<br>
F3_C_R: <b>p < 0.001</b><br>
F3_E_N: p = 0.00451869795566720<br>
F3_E_R: p = 0.07964145292327768<br>

Since 9/14 tests indicate a deviation from a normal distribution (p < 0.003), we test the fit of multiple alternative distributions to determine whether there is consistent best-fitting distribution for the data across groups of interest.

#### 3b: Test fit of empirical data to alternative distributions; run the Rmd chunk below.
In this step, we plot the raw data distribution and test the fit of four potential distributions that commonly underlie count data (i.e., normal, log-normal, poisson, and negative binomial), and determine the best fitting distribution for each group of interest.

##### Test fit of alternative distributions:
```{r}
# load pupa duration data
load("data/pupa_duration.Rda")

# Generate combined "group" factor, which includes larval generation, background, and treatment, to test distributions within each group of interest.
pupa_duration <- pupa_duration %>%
  unite(group, larval_generation, c(background, treatment), sep = "_", remove = F) %>%
  mutate(group = factor(group))

# generate list of levels within group factor
levels <- levels(pupa_duration$group)

# define empty lists to hold statistics for each distribution test
unif <- list()
norm <- list()
lnor <- list()
gamm <- list() 

# Write for loop to fit each distribution to data, iterating through group levels (i)
for(i in levels) {
  
  # generate subsets of data for each group level
  subset <- pupa_duration[pupa_duration$group == i, ]
  
  # fit distributions to leaf area for each subset
  fit_unif <- fitdist(subset$pupa_duration, "unif") 
  fit_norm <- fitdist(subset$pupa_duration, "norm")
  fit_lnor <- fitdist(subset$pupa_duration, "lnorm") 
  fit_gamm <- fitdist(subset$pupa_duration, "gamma") 
  
  # fill list with fit results for each distribution
  unif[[i]] <- fit_unif
  norm[[i]] <- fit_norm
  lnor[[i]] <- fit_lnor 
  gamm[[i]] <- fit_gamm
  
}

# Get table of distribution stats for F0 C N group
stats_1 <- data_frame(F0_C_N = gofstat(list(unif$F0_C_N,
                                            norm$F0_C_N,
                                            lnor$F0_C_N, 
                                            gamm$F0_C_N))$aic)

# Get table of distribution stats for F0 E N group
stats_2 <- data_frame(F0_E_N = gofstat(list(unif$F0_E_N,
                                            norm$F0_E_N,
                                            lnor$F0_E_N, 
                                            gamm$F0_E_N))$aic)

# Get table of distribution stats for F1 C N group
stats_3 <- data_frame(F1_C_N = gofstat(list(unif$F1_C_N,
                                            norm$F1_C_N,
                                            lnor$F1_C_N, 
                                            gamm$F1_C_N))$aic)

# Get table of distribution stats for F1 C R group
stats_4 <- data_frame(F1_C_R = gofstat(list(unif$F1_C_R, 
                                            norm$F1_C_R,
                                            lnor$F1_C_R, 
                                            gamm$F1_C_R))$aic)
         
# Get table of distribution stats for F1 E N group
stats_5 <- data_frame(F1_E_N = gofstat(list(unif$F1_E_N, 
                                            norm$F1_E_N,
                                            lnor$F1_E_N,
                                            gamm$F1_E_N))$aic)

# Get table of distribution stats for F1 E R group
stats_6 <- data_frame(F1_E_R = gofstat(list(unif$F1_E_R, 
                                            norm$F1_E_R,
                                            lnor$F1_E_R,
                                            gamm$F1_E_R))$aic)

# Get table of distribution stats for F2 C N group
stats_7 <- data_frame(F2_C_N = gofstat(list(unif$F2_C_N, 
                                            norm$F2_C_N,
                                            lnor$F2_C_N,
                                            gamm$F2_C_N))$aic)

# Get table of distribution stats for F2 C R group
stats_8 <- data_frame(F2_C_R = gofstat(list(unif$F2_C_R, 
                                            norm$F2_C_R,
                                            lnor$F2_C_R,
                                            gamm$F2_C_R))$aic)

# Get table of distribution stats for F2 E N group
stats_9 <- data_frame(F2_E_N = gofstat(list(unif$F2_E_N, 
                                            norm$F2_E_N,
                                            lnor$F2_E_N,
                                            gamm$F2_E_N))$aic)

# Get table of distribution stats for F2 E R group
stats_10 <- data_frame(F2_E_R = gofstat(list(unif$F2_E_R, 
                                             norm$F2_E_R,
                                             lnor$F2_E_R,
                                             gamm$F2_E_R))$aic)

# Get table of distribution stats for F3 C N group
stats_11 <- data_frame(F3_C_N = gofstat(list(unif$F3_C_N, 
                                             norm$F3_C_N,
                                             lnor$F3_C_N,
                                             gamm$F3_C_N))$aic)

# Get table of distribution stats for F3 C R group
stats_12 <- data_frame(F3_C_R = gofstat(list(unif$F3_C_R, 
                                             norm$F3_C_R,
                                             lnor$F3_C_R,
                                             gamm$F3_C_R))$aic)

# Get table of distribution stats for F3 E N group
stats_13 <- data_frame(F3_E_N = gofstat(list(unif$F3_E_N, 
                                             norm$F3_E_N,
                                             lnor$F3_E_N,
                                             gamm$F3_E_N))$aic)

# Get table of distribution stats for F3 E R group 
stats_14 <- data_frame(F3_E_R = gofstat(list(unif$F3_E_R,
                                             norm$F3_E_R,
                                             lnor$F3_E_R,
                                             gamm$F3_E_R)))

# combine all stats into a single table and add a first column with the name of the distribution being tested
stats <- cbind(distribution = c("uniform", "normal", "log-normal", "gamma"), 
               stats_1, 
               stats_2, 
               stats_3, 
               stats_4,
               stats_5, 
               stats_6, 
               stats_7,
               stats_8, 
               stats_9, 
               stats_10, 
               stats_11, 
               stats_12, 
               stats_13, 
               stats_14)

# Run individual global distributions 
unif <- fitdist(pupa_duration$pupa_duration, "unif")
norm <- fitdist(pupa_duration$pupa_duration, "norm")
lnor <- fitdist(pupa_duration$pupa_duration, "lnorm")
gamm <- fitdist(pupa_duration$pupa_duration, "gamma")

# compare AIC values 
gofstat(list(unif, 
             norm,
             lnor,
             gamm),
        fitnames = c("uniform",
                     "normal",
                     "log-normal",
                     "gamma"))$aic
```

<b>Analysis results:</b> <br>

| Group     | Uniform          | Normal           | Log-normal       | Gamma              | 
|:----------|:-----------------|:-----------------|:-----------------| :----------------- |
| F0_C_N    | <b>4.000</b>     | 88.123           | 88.316           | 88.214             | 
| F0_E_N    | <b>56.679</b>    | 65.629           | 66.391           | 66.068             |
| F1_C_N    | 54.536           | 51.473           | <b>49.788</b>    | 50.257             |
| F1_C_R    | 42.627           | 43.516           | <b>39.450</b>    | 40.716             |
| F1_E_N    | <b>34.499</b>    | 39.916           | 40.246           | 40.090             | 
| F1_E_R    | <b>36.958</b>    | 44.345           | 45.537           | 45.065             |
| F2_C_N    | <b>28.953</b>    | 34.627           | 34.889           | 34.749             |
| F2_C_R    | <b>4.000</b>     | 18.108           | 18.445           | 18.323             |
| F2_E_N    | 40.044           | <b>37.876</b>    | 43.613           | 41.573             |
| F2_E_R    | NA               | <b>12.979</b>    | 25.809           | NA                 |
| F3_C_N    | <b>19.249</b>    | 26.342           | 26.581           | 26.467             |
| F3_C_R    | <b>25.972</b>    | 32.771           | 30.745           | 31.388             |
| F3_E_N    | <b>23.40812</b>  | 33.736           | 34.573           | 34.254             |
| F3_E_R    | <b>23.313</b>    | 27.450           | 30.566           | 29.356             | 
| Global    | 1150.951         | <b>640.818</b>   | 688.246          | 664.926            |

The data in the majority of groups were fit to a uniform distribution. Some groups were best fit with the normal distribution (i.e., F1_E_N and F1_E_R) or the log-normal distribution (i.e., F1_C_N and F1_C_R). However, the best fitting distribution to the global dataset across groups was normal. We therefore opted to assume a normal distribution in all linear model analyses given that it is biologically unlikely that pupal duration follows a uniform distribution.

These data are presented in Table XXX in the final ms.

#### 3c: Plot empirical data distribution; run the Rmd chunk below.

##### Plot empirical data distribution for pupa duration: `figures/pupa_duration_distribution.jpeg`
```{r}
# load pupa time data
load("data/pupa_duration.Rda")

# plot distribution
jpeg("figures/pupa_duration_distribution.jpeg", width = 5000, height = 4000, res = 500)

ggplot(pupa_duration, aes(x = pupa_duration)) +
  geom_histogram(binwidth = 1, color = "black", fill = "grey", linewidth = 1) +
  theme_set(theme_cowplot(12)) +
  scale_x_continuous(breaks = seq(from = 0, to = 15, by = 5),
                     limits = c(0,15)) +
  scale_y_continuous(breaks = seq(from = 0, to = 140, by = 20),
                     limits = c(0,140)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  xlab("Duration of pupal stage (days)") +
  ylab("Frequency") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

This figure is presented as Figure XXX in the final ms.

#### 3d: Run two-factor linear mixed effect interaction models assuming a normal distribution to test the relative effects of background and treatment of insecticide stress on pupa duration; run the Rmd chunk below.
In this step, we run general linear mixed effect interaction models with raw duration of pupation as a response, interacting fixed effects of background and treatment, and lineage as a random effect. We assume an underlying normal distribution for the data (see Step 3b above).

##### Run linear mixed effect interaction models for pupa mass:
```{r}
# load pupa duration data
load("data/pupa_duration.Rda")

# isolate only F0 data
f0 <- pupa_duration %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_duration %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_duration %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_duration %>%
  filter(larval_generation == "F3")

# f0 linear mixed effect model
f0_mod <- lmer(pupa_duration ~ background + (1|lineage),
               data = f0)

# f1 linear mixed effect model
f1_mod <- lmer(pupa_duration ~ treatment*background + (1|lineage),
               data = f1)

# f2 linear mixed effect model
f2_mod <- lmer(pupa_duration ~ treatment*background + (1|lineage),
               data = f2)

# f2 linear mixed effect model
f3_mod <- lmer(pupa_duration ~ treatment*background + (1|lineage),
               data = f3)

# summarize f0 model
anova(f0_mod) # get F value
Anova(f0_mod) # get p value
emmeans(f0_mod, poly ~ background) # get marginal means and pairwise contrasts
df.residual(f0_mod) # get degrees of freedom

# summarize f1 model
anova(f1_mod) # get F value
Anova(f1_mod) # get p values
emmeans(f1_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f1_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f1_mod) 

# summarize f2 model
anova(f2_mod) # get F value
Anova(f2_mod) # get p values
emmeans(f2_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f2_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f2_mod) # get degrees of freedom

# summarize f3 model
anova(f3_mod) # get F value
Anova(f3_mod) # get p values
emmeans(f3_mod, poly ~ background|treatment) # get marginal means and pairwise contrasts for backgrounds within treatments
emmeans(f3_mod, poly ~ treatment|background) # get marginal means and pairwise contrasts for treatments within backgrounds
df.residual(f3_mod) # get degrees of freedom
```

<b>Analysis results:</b> <br>

<b>Coefficients of linear mixed effect models by generation:</b><br>
<b>F0</b>: <br>
Background: F = 0.8957; p = 0.3439 <br>
d.f. = 92 <br>

<b>F1</b>: <br>
Treatment: F = 0.0116; p = 0.2973 <br>
Background: F = 0.4458; p = 0.7397 <br>
Treatment x Background : F = 0.6869; p = 0.1855 <br>
d.f. = 66 <br>

<b>F2</b>: <br>
Treatment: F = 0.0277; p = 0.8253 <br>
Background: F = 0.2886; p = 0.5912 <br>
Treatment x Background: F = 2.1683; p = 0.1409 <br>
d.f. = 46 <br>

<b>F3</b>: <br>
Treatment: F = 1.3714; p = 0.92344 <br>
Background: F = 0.6927; p = 0.41006 <br>
Treatment x Background: F = 3.4878; p = 0.06182 <br>
d.f. = 35 <br>

These data are presented in Table 3a in the final ms.

#### 3e: Plot mean pupa duration data; run the Rmd chunk below.

##### Plot mean data: `figures/pupa_duration_means.jpeg`
```{r}
# load pupa duration data
load("data/pupa_duration.Rda")

# get sample size (n), mean or proportion, standard deviation (sd), and standard error (se) for herbivory by generation, background, and treatment for plotting
pupa_duration <- pupa_duration %>%
  group_by(larval_generation, background, treatment) %>%
  summarize(mean = mean(pupa_duration),
            sd = sd(pupa_duration),
            n = n(),
            se = sd/sqrt(n))

# isolate only F0 data
f0 <- pupa_duration %>%
  filter(larval_generation == "F0")

# isolate only F1 data
f1 <- pupa_duration %>%
  filter(larval_generation == "F1")

# isolate only F2 data
f2 <- pupa_duration %>%
  filter(larval_generation == "F2")

# isolate only F3 data
f3 <- pupa_duration %>%
  filter(larval_generation == "F3")

# plot f0 data
f0_plot <- ggplot(f0, aes(x = background, y = mean, group = background, color = background)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
   geom_point(aes(x = background, y = mean, group = background, fill = background), 
              position = position_dodge(width = 0.4), 
              size = 7, 
              pch = 22, 
              stroke = 2, 
              color = "black", 
              show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 4, to = 8, by = 1),
                     limits = c(4,8)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 30, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  labs(x = "Original exposure", y = "Duration (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f1 data
f1_plot <- ggplot(f1, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 4, to = 8, by = 1),
                     limits = c(4,8)) +
  theme(axis.title = element_text(size = 30)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  #theme(legend.text = element_text(size = 30)) +
  #theme(legend.title = element_text(size = 30, face = "bold")) +
  #theme(legend.key.size = unit(2, 'cm')) +
  #theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  #theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  #theme(legend.box.margin = margin(5, 10, 1, 10)) +
  #theme(legend.position = c(0.05,0.2)) + 
  labs(x = "Treatment", y = "Duration (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f2 data
f2_plot <- ggplot(f2, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background), 
             position = position_dodge(width = 0.4), 
             size = 7, 
             pch = 22, 
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 4, to = 8, by = 1),
                     limits = c(4,8)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment", y = "Duration (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot f3 data
f3_plot <- ggplot(f3, aes(x = treatment, y = mean, group = background, color = background)) +
  geom_line(aes(color = background), 
            position = position_dodge(width = 0.4), 
            linewidth = 2, 
            show.legend = F) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), 
                position = position_dodge(width = 0.4), 
                width = 0.2, 
                linewidth = 2, 
                show.legend = F) +
  geom_point(aes(x = treatment, y = mean, group = background, fill = background),
             position = position_dodge(width = 0.4), 
             size = 7,
             pch = 22,
             stroke = 2, 
             color = "black", 
             show.legend = F) +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 4, to = 8, by = 1),
                     limits = c(4,8)) +
  theme(axis.text = element_text(size = 30)) + 
  theme(axis.title = element_text(size = 30)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  labs(x = "Treatment", y = "Duration (days)") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

# plot all pupa duration figures together
jpeg("figures/pupa_duration_means.jpeg", width = 20000, height = 4000, res = 1000)

f0_plot + f1_plot + f2_plot + f3_plot + plot_layout(nrow = 1, ncol = 4)

dev.off()
```

This figure is presented as Figure XXX in the final ms.