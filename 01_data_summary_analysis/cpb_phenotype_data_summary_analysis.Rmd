---
title: "Analysis 1: Data filtering and summary analysis"
author: "Joe Gunn"
date: "2024-09-19"
output: html_document
---

# <b>Project:</b> Assessing phenotypic response and transgenerational inheritance following insecticide exposure in Colorado Potato Beetles (<i>Leptinotarsa decemlineata</i>; CPB) 
<font size="+1"> We assessed inter- and trans-generational effects of sublethal insecticide exposure on four larval performance phenotypes (mobility, herbivory, development, and fecundity) in Colorado potato beetles (<i>Leptinotarsa decemlineata/i>; CPB). We implemented a replicated inbred full-sibling pedigree design, beginning with 12 "founder" mated pair lineages and continuing for four successive generations (full siblings within lineages were inbred in each generation). For the transgenerational experiment, F<sub>0</sub> larvae (offspring of founder pairs) were divided into two treatment groups (exposed, i.e., exposed to a sub-lethal dose of the neonicotinoid insecticide imidacloprid; and control, i.e., exposed to an equivalent dose of molecular-grade water). A subset of beetles were collected from each treatment within each lineage for each generation and monitored for four performance traits, including larval movement (mobility), feeding rate (herbivory), and time to discrete life stages (development). Performance traits were monitored in three successive generations (F<sub>1</sub>-F<sub>3</sub>) without treatment exposure and compared to the F<sub>0</sub> generation to test for inter- and transgenerationally-inherited phenotypic variation. An additional subset of larvae from each generation were re-exposed to treatments, both experimental (insecticide-exposed) and control (water), to test for potential selection of phenotypic variation across generations.</font>

# <b>Specific Aim:</b> Data enumeration, preparation, and filtering
<font size="+1">Here, we clean, filter and fully prepare data for downstream analyses. We then summarize the full phenotype data set (including metrics for survival, mobility, herbivory, and development) for XXX larval Colorado potato beetle samples (<i>Leptinotarsa decemlineata</i>; CPB) derived from 12 founder lineages, two insecticide treatment groups (exposed and control), and four successive generations (F0-F3) in a transgenerational experiment. We include a full description of all types of data collected. Additionally, we provide the total number of samples in all group combinations. </font>

## Phases of Analysis
### Phase 1: Data preparation and filtering
### Phase 2: Data summarization and enumeration

### Libraries needed for analysis
```{r}
library(tidyverse)
library(cowplot)
library(readxl)
library(writexl)
```

## PHASE 1: DATA PREPARATION AND FILTERING
In this phase of the analysis, we read in and clean the raw metadata, performance data, fecundity data, and adult mass data for all samples and generate separate datasets for each performance metric of interest, along with a complete, clean dataset with all metrics for multivariate analysis.

### STEP 1: Read in and clean fecundity and performance data; run the Rmd chunk below.
In this step, we read in, clean all data and merge metadata with raw fecundity (and mass) and performance data. We prepare clean datasets for downstream filtering and organization steps.

##### Read in and clean data:
```{r}
# read in metadata 
metadata <- read_excel("../raw_data/cpb_tei_metadata.xlsx")

# read in raw performance data 
performance <- read_excel("../raw_data/cpb_tei_performance_data.xlsx")

# read in raw fecundity data
fecundity <- read_excel("../raw_data/cpb_tei_fecundity_data.xlsx")

# read in mass data
mass <- read_excel("../raw_data/cpb_tei_mass_data.xlsx")

# convert characters to factors in metadata
metadata <- metadata %>%
  mutate(ind_id = factor(ind_id),
         type = factor(type),
         pair_id = factor(pair_id),
         adult_generation = factor(adult_generation),
         larval_generation = factor(larval_generation),
         lineage = factor(lineage),
         treatment = factor(treatment),
         sex = factor(sex))

# save metadata for downstream analyses
save(metadata, file = "data/metadata.Rda")

# convert characters to factors (categorical variables) and numerics (numeric variables) in performance data and eliminate L4 date column
performance <- performance %>%
  mutate(ind_id = factor(ind_id),
         larval_generation = factor(larval_generation),
         lineage = factor(lineage),
         treatment = factor(treatment),
         sex = factor(sex),
         plate = factor(plate),
         well = factor(well),
         ind_number = factor(ind_number),
         dose = factor(dose),
         molt = factor(molt),
         total_leaf_area = as.numeric(total_leaf_area),
         leaf_area_consumed = as.numeric(leaf_area_consumed),
         percent_leaf_consumed = as.numeric(percent_leaf_consumed)) %>%
  select(-c(L4_date))

# merge performance data with metadata (get only "assayed" individuals from metadata to reduce confusion, and then merge)
performance <- metadata %>%
  filter(type == "assayed") %>%
  full_join(performance, by = c("ind_id","larval_generation","lineage","treatment","sex"))

# save performance data for downstream analyses
save(performance, file = "data/performance.Rda")

# convert characters to factors in fecundity data
fecundity <- fecundity %>%
  mutate(notebook = factor(notebook),
         pair_id = factor(pair_id),
         adult_generation = factor(adult_generation),
         larval_generation = factor(larval_generation),
         lineage = factor(lineage),
         treatment = factor(treatment),
         status = factor(status))

# convert characters to factors in mass data
mass <- mass %>%
  mutate(lineage = factor(lineage),
         adult_generation = factor(adult_generation),
         treatment = factor(treatment),
         temp_label = factor(temp_label),
         pair_id = factor(pair_id),
         notebook = factor(notebook),
         sex = factor(sex),
         designation = factor(designation))

# spread mass dataset by sex
mass <- mass %>%
  spread(sex, mass)

# merge fecundity data with mass
fecundity <- mass %>%
  filter(designation == "main") %>%
  select(-c(temp_label)) %>%
  full_join(fecundity, by = c("pair_id","notebook","adult_generation","lineage","treatment"))

# save fecundity data for downstream analyses
save(fecundity, file = "data/fecundity.Rda")
```

### STEP 2: Generate separate datasets for each phenotypic metric of interest.
In this step, we filter the full phenotype data generated in STEP 1 above to generate separate datasets for each of four phenotypic metrics: 1) fecundity, 2) herbivory, 3) mobility, and 4) development.

### 

```{r}
