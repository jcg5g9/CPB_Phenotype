---
ttitle: "Analysis 4: Mobility analysis"
author: "Joe Gunn"
date: "2024-09-19"
output: html_document
---

# <b>Project:</b> Assessing phenotypic response and transgenerational inheritance following insecticide exposure in Colorado Potato Beetles (<i>Leptinotarsa decemlineata</i>; CPB) 
<font size="+1"> We assessed inter- and trans-generational effects of sublethal insecticide exposure on four larval performance phenotypes (fecundity, herbivory, mobility, and development) in Colorado potato beetles (<i>Leptinotarsa decemlineata</i>; CPB). We implemented a replicated inbred full-sibling pedigree design, beginning with 12 "founder" mated pair lineages and continuing for four successive generations (full siblings within lineages were inbred in each generation). For the transgenerational experiment, F<sub>0</sub> larvae (offspring of founder pairs) were divided into two treatment groups (exposed, i.e., exposed to a sub-lethal [10-ppm] dose of the neonicotinoid insecticide imidacloprid; and control, i.e., exposed to an equivalent dose of molecular-grade water). A subset of beetles were collected from each treatment within each lineage for each generation and monitored for four performance traits, including larval movement (mobility), feeding rate (herbivory), and time to discrete life stages (development). Performance traits were monitored in three successive generations (F<sub>1</sub>-F<sub>3</sub>) without treatment exposure and compared to the F<sub>0</sub> generation to test for inter- and transgenerationally-inherited phenotypic variation. An additional subset of larvae from each generation were re-exposed to treatments, both experimental (insecticide-exposed) and control (water), to test for potential selection of phenotypic variation across generations.</font>

# <b>Specific Aim:</b> Mobility analysis
<font size="+1">In this analysis, we assess differences in larval mobility (i.e., total distance walked, average walking rate, and average walking acceleration) among mated pairs in the transgenerational experiment by generation (i.e., F0, F1, F2, F3), lineage (i.e., L1, L2, ... L10), and treatment (i.e., control and exposed). </font>

## Phases of Analysis
### Phase 1: Data Summary Statistics
### Phase 2: Mobility Analysis

### Libraries needed for analysis:
```{r}
library(tidyverse)
library(cowplot)
library(readxl)
library(writexl)
library(rstatix)
```

## PHASE 1: DATA SUMMARY STATISTICS
In this phase of the analysis, we calculate mean, standard deviation, and variance for mobility metrics within experimental groups of interest.

### STEP 1: Calculate summary statistics for larval mobility data; run the Rmd chunk below.
In this step, we calculate mean, standard deviation, and variance for mobility (i.e., walking speed, walking acceleration, and total distance walked) for all experimental groups.

##### Calculate summary statistics for larval mobility data:
```{r}
# load mobility data
load("data/mobility.Rda")

# get sample size (n), mean, standard deviation (sd), and standard error (se) for walking rate by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(ave_speed),
            sd = sd(ave_speed),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for average acceleration by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(ave_accel),
            sd = sd(ave_accel),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for distance walked by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(total_distance),
            sd = sd(total_distance),
            se = sd/sqrt(n()))
```

## PHASE 2: MOBILITY ANALYSIS
In this phase of the analysis, we assess differences in larval mobility metrics (i.e., total distance walked, average walking rate, and average walking acceleration) between treatments and across generations.

### STEP 1: Assess differences in total distance walked.
In this step, we assess differences in total distance walked by larvae between treatments and across generations.

#### 1a: Test fit of empirical data to a normal distribution; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether total distance walked among larvae in each group of interest deviates from a normal distribution.

##### Test fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(total_distance) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.001 </b><br>
<b>F0_C_E: p < 0.001 </b><br>
<b>F1_C_C: p = 0.002 </b><br>
<b>F1_C_E: p = 0.011 </b><br>
<b>F1_E_C: p < 0.001 </b><br>
<b>F1_E_E: p < 0.001 </b><br>
<b>F2_C_C: p = 0.633 </b><br>
<b>F2_C_E: p = 0.015 </b><br>
<b>F2_E_C: p = 0.108 </b><br>
<b>F2_E_E: p = 0.190 </b><br>
<b>F3_C_C: p = 0.001 </b><br>
<b>F3_C_E: p = 0.017 </b><br>
<b>F3_E_C: p = 0.047 </b><br>
<b>F3_E_E: p < 0.001 </b><br>

Since 7/14 tests for normality fit indicate a deviation from a normal distribution, we apply a square-root transformation to the raw data to prepare for analysis.

#### 1b: Square-root transform total distance walked data and re-assess fit of normal distribution; run the Rmd chunk below.
In this step, we calculate the square root of the raw total distance data and re-assess the fit of the transformed data to a normal distribution.

##### Transform data and re-assess fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# square root transform total distance data and add to dataset
mobility <- mobility %>%
  mutate(sqrt_distance = sqrt(total_distance))

# re-assess fit of normality to square-root-transformed data
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(sqrt_distance) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.434 </b><br>
<b>F0_C_E: p < 0.009 </b><br>
<b>F1_C_C: p = 0.422 </b><br>
<b>F1_C_E: p = 0.516 </b><br>
<b>F1_E_C: p < 0.235 </b><br>
<b>F1_E_E: p < 0.014 </b><br>
<b>F2_C_C: p = 0.489 </b><br>
<b>F2_C_E: p = 0.366 </b><br>
<b>F2_E_C: p = 0.659 </b><br>
<b>F2_E_E: p = 0.074 </b><br>
<b>F3_C_C: p = 0.133 </b><br>
<b>F3_C_E: p = 0.587 </b><br>
<b>F3_E_C: p = 0.337 </b><br>
<b>F3_E_E: p < 0.271 </b><br>

All 14 tests indicate fit of the normal distribution, so we continue with analysis using these transformed data.

### STEP 2: Assess differences in average walking speed.
In this step, we assess differences in average walking speed by larvae between treatments and across generations.

#### 2a: Test fit of empirical data to a normal distribution; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether average walking speed among larvae in each group of interest deviates from a normal distribution.

##### Test fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(ave_speed) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.001 </b><br>
<b>F0_C_E: p < 0.001 </b><br>
<b>F1_C_C: p < 0.001 </b><br>
<b>F1_C_E: p = 0.010 </b><br>
<b>F1_E_C: p = 0.002 </b><br>
<b>F1_E_E: p < 0.001 </b><br>
<b>F2_C_C: p = 0.180 </b><br>
<b>F2_C_E: p = 0.010 </b><br>
<b>F2_E_C: p = 0.082 </b><br>
<b>F2_E_E: p = 0.199 </b><br>
<b>F3_C_C: p < 0.001 </b><br>
<b>F3_C_E: p = 0.012 </b><br>
<b>F3_E_C: p = 0.011 </b><br>
<b>F3_E_E: p < 0.001 </b><br>

Since 7/14 tests for normality fit indicate a deviation from a normal distribution, we apply a square-root transformation to the raw data to prepare for analysis.

#### 2b: Square-root transform average walking speed data and re-assess fit of normal distribution; run the Rmd chunk below.
In this step, we calculate the square root of the raw average speed data and re-assess the fit of the transformed data to a normal distribution.

##### Transform data and re-assess fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# square root transform walking speed data and add to dataset
mobility <- mobility %>%
  mutate(sqrt_speed = sqrt(ave_speed))

# re-assess fit of normality to square-root-transformed data
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(sqrt_speed) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p = 0.436 </b><br>
<b>F0_C_E: p = 0.008 </b><br>
<b>F1_C_C: p = 0.289 </b><br>
<b>F1_C_E: p = 0.394 </b><br>
<b>F1_E_C: p = 0.354 </b><br>
<b>F1_E_E: p = 0.103 </b><br>
<b>F2_C_C: p = 0.423 </b><br>
<b>F2_C_E: p = 0.343 </b><br>
<b>F2_E_C: p = 0.577 </b><br>
<b>F2_E_E: p = 0.094 </b><br>
<b>F3_C_C: p = 0.100 </b><br>
<b>F3_C_E: p = 0.548 </b><br>
<b>F3_E_C: p = 0.169 </b><br>
<b>F3_E_E: p = 0.159 </b><br>

All 14 tests indicate fit of the normal distribution, so we continue with analysis using these transformed data.

### STEP 3: Assess differences in average walking acceleration.
In this step, we assess differences in average walking acceleration by larvae between treatments and across generations.

#### 3a: Test fit of empirical data to a normal distribution; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether average walking acceleration among larvae in each group of interest deviates from a normal distribution.

##### Test fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(ave_accel) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.001 </b><br>
<b>F0_C_E: p < 0.001 </b><br>
<b>F1_C_C: p = 0.072 </b><br>
<b>F1_C_E: p < 0.001 </b><br>
<b>F1_E_C: p < 0.001 </b><br>
<b>F1_E_E: p < 0.001 </b><br>
<b>F2_C_C: p = 0.091 </b><br>
<b>F2_C_E: p = 0.107 </b><br>
<b>F2_E_C: p = 0.055 </b><br>
<b>F2_E_E: p = 0.891 </b><br>
<b>F3_C_C: p < 0.001 </b><br>
<b>F3_C_E: p = 0.008 </b><br>
<b>F3_E_C: p = 0.002 </b><br>
<b>F3_E_E: p = 0.001 </b><br>

Since 8/14 tests for normality fit indicate a deviation from a normal distribution, we apply a square-root transformation to the raw data to prepare for analysis.

#### 3b: Square-root transform average walking acceleration data and re-assess fit of normal distribution; run the Rmd chunk below.
In this step, we calculate the square root of the raw average acceleration data and re-assess the fit of the transformed data to a normal distribution.

##### Transform data and re-assess fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# square root transform walking acceleration data and add to dataset
mobility <- mobility %>%
  mutate(sqrt_accel = sqrt(ave_accel))

# re-assess fit of normality to square-root-transformed data
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(sqrt_accel) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p = 0.011 </b><br>
<b>F0_C_E: p = 0.007 </b><br>
<b>F1_C_C: p = 0.652 </b><br>
<b>F1_C_E: p = 0.595 </b><br>
<b>F1_E_C: p = 0.129 </b><br>
<b>F1_E_E: p = 0.004 </b><br>
<b>F2_C_C: p = 0.609 </b><br>
<b>F2_C_E: p = 0.157 </b><br>
<b>F2_E_C: p = 0.368 </b><br>
<b>F2_E_E: p = 0.353 </b><br>
<b>F3_C_C: p = 0.004 </b><br>
<b>F3_C_E: p = 0.296 </b><br>
<b>F3_E_C: p = 0.076 </b><br>
<b>F3_E_E: p = 0.145 </b><br>

All 14 tests indicate fit of the normal distribution, so we continue with analysis using these transformed data.

```{r}
# visualize distribution of total distance walked and generate figure 
jpeg("figures/distance_histogram.jpeg", width = 10000, height = 8000, res = 700)

ggplot(mobility, aes(x = total_distance, fill = treatment)) + 
  geom_histogram(position = "identity", alpha = 0.7, binwidth = 20, color = "black") +
  theme_set(theme_cowplot(12)) +
  facet_wrap(~larval_generation) + 
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  theme(strip.text.x = element_text(size = 30, color = "black", face = "bold.italic")) +
  theme(strip.background = element_rect(color = "black", size = 2)) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.75)) +
  theme(legend.position = c(0.36,0.9)) + 
  theme(legend.text = element_text(size = 20)) +
  theme(legend.title = element_text(size = 20, face = "bold")) +
  theme(legend.key.size = unit(1, 'cm')) +
  theme(legend.key.spacing.y = unit(0.2, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(10, 10, 10, 10)) +
  labs(x = "Total distance walked (mm)", y = "Frequency", fill = "Treatment") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(15,15,15,15))

dev.off()
```


