---
ttitle: "Analysis 4: Mobility analysis"
author: "Joe Gunn"
date: "2024-09-19"
output: html_document
---

# <b>Project:</b> Assessing phenotypic response and transgenerational inheritance following insecticide exposure in Colorado Potato Beetles (<i>Leptinotarsa decemlineata</i>; CPB) 
<font size="+1"> We assessed inter- and trans-generational effects of sublethal insecticide exposure on four larval performance phenotypes (fecundity, herbivory, mobility, and development) in Colorado potato beetles (<i>Leptinotarsa decemlineata</i>; CPB). We implemented a replicated inbred full-sibling pedigree design, beginning with 12 "founder" mated pair lineages and continuing for four successive generations (full siblings within lineages were inbred in each generation). For the transgenerational experiment, F<sub>0</sub> larvae (offspring of founder pairs) were divided into two "background" groups (exposed, i.e., exposed to a sub-lethal [10-ppm] dose of the neonicotinoid insecticide imidacloprid; and control, i.e., exposed to an equivalent dose of molecular-grade water). All mated pair beetles across lineages, treatments, and generations were monitored for daily fecundity. A subset of third instar larvae were collected from each treatment within each lineage for each generation and monitored for three  performance traits, including larval movement (mobility), feeding rate (herbivory), and time to discrete life stages (development). Performance traits were monitored in three successive generations (F<sub>1</sub>-F<sub>3</sub>) without treatment exposure and compared to the F<sub>0</sub> generation to test for inter- and transgenerationally-inherited "memory" of phenotypic variation. An additional subset of larvae from each generation were re-exposed to the treatments, both experimental (insecticide-exposed) and control (water), to test for potential inheritance of a phenotypic "response" to insecticide stress.</font>

# <b>Specific Aim:</b> Mobility analysis
<font size="+1">In this analysis, we assess differences in larval mobility (i.e., total distance walked, average walking rate, and average walking acceleration) among mated pairs in the transgenerational experiment by generation (i.e., F0, F1, F2, F3), lineage (i.e., L1, L2, ... L10), and treatment (i.e., control and exposed). </font>

## Phases of Analysis
### Phase 1: Data Summary Statistics
### Phase 2: Mobility Analysis

### Libraries needed for analysis:
```{r}
library(tidyverse)
library(cowplot)
library(readxl)
library(writexl)
library(rstatix)
library(lme4)
library(broom)
```

## PHASE 1: DATA SUMMARY STATISTICS
In this phase of the analysis, we calculate mean, standard deviation, and variance for mobility metrics within experimental groups of interest.

### STEP 1: Calculate summary statistics for larval mobility data; run the Rmd chunk below.
In this step, we calculate mean, standard deviation, and variance for mobility (i.e., walking speed, walking acceleration, and total distance walked) for all experimental groups.

##### Calculate summary statistics for larval mobility data:
```{r}
# load mobility data
load("data/mobility.Rda")

# get sample size (n), mean, standard deviation (sd), and standard error (se) for walking rate by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(ave_speed),
            sd = sd(ave_speed),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for average acceleration by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(ave_accel),
            sd = sd(ave_accel),
            se = sd/sqrt(n()))

# get sample size (n), mean, standard deviation (sd), and standard error (se) for distance walked by generation and treatment
mobility %>%
  group_by(larval_generation, background, treatment) %>% 
  summarize(n = n(),
            mean = mean(total_distance),
            sd = sd(total_distance),
            se = sd/sqrt(n()))
```

## PHASE 2: MOBILITY ANALYSIS
In this phase of the analysis, we assess differences in larval mobility metrics (i.e., total distance walked, average walking rate, and average walking acceleration) between treatments and across generations, accounting for variation across lineages as a random effect in a linear mixed-effect model framework. We conduct two primary analyses: 1) assessing inheritance of phenotypic "memory" of stress by comparing phenotypic variation (i.e., mobility metrics) in beetles with a background (F0 exposure) of insecticide vs. those with a background of the water control and without subsequent exposure in successive generations; and 2) assessing inheritance of a phenotypic "response" to stress by comparing phenotypic variation (i.e., mobility metrics) in beetles treated in each generation with insecticide or a water control and which had a background (F0 exposure) of either insecticide or the water control. 

### STEP 1: Simulate data to visualize hypotheses for assessing phenotypic memory and phenotypic response following insecticide exposure.
In this step, we generate figures representing null and alternative hypotheses for assessing phenotypic memory vs. phenotypic response following exposure to the insecticide and control treatments in the transgenerational experiment. We generate simulated data and graphically visualize expected patterns of phenotypic variation between treatments and across generations.

#### 1a: Simulate data and visualize null (H<sub>n</sub>) and alternative (H<sub>a</sub>) hypotheses for phenotypic memory analysis.
Here, we generate data tables to simulate expected patterns in phenotpyic memory assuming the null hypothesis (i.e., that any phenotypic difference between control and insecticide-exposed individuals in the F0 generation will not be maintained over successive generations) and alternative hypothesis (i.e., that any phenotypic difference between control and insecticide-treated F0 individuals will be maintained accross generations).

##### 1a.1. Simulate and visualize data for H<sub>n</sub>; run the Rmd chunk below.

##### Simulate data and generate figure for H<sub>n</sub>: `figures/hn_memory.jpeg`
```{r}
# generate test data for null hypothesis
hn_memory <- tibble(
  larval_generation = c(rep("F0", times = 2),
                        rep("F1", times = 2), 
                        rep("F2", times = 2), 
                        rep("F3", times = 2)),
  background = c(rep(c("C","E"), times = 4)),
  treatment = c(rep("C", times = 8)),
  mean = as.numeric(c(rep("10", times = 1),
           rep("5", times = 1),
           rep("10", times = 6))),
  se = as.numeric(c(rep("0.8", times = 8))),
  )

# plot hypothesis data by background, generation, and treatment
jpeg("figures/hn_memory.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(hn_memory, aes(x = larval_generation, y = mean, group = background)) + 
  geom_line(aes(color = background), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = background, fill = background), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Background", color = "Background") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

##### 1a.2. Simulate and visualize data for H<sub>a</sub>; run the Rmd chunk below.

##### Simulate data and generate figure for H<sub>a</sub>: `figures/ha_memory.jpeg`
```{r}
# generate test dataset for alternative hypothesis
ha_memory <- tibble(
  larval_generation = c(rep("F0", times = 2),
                        rep("F1", times = 2), 
                        rep("F2", times = 2), 
                        rep("F3", times = 2)),
  background = c(rep(c("C","E"), times = 4)),
  treatment = c(rep("C", times = 8)),
  mean = as.numeric(c(rep(c("10","5"), times = 4))),
  se = as.numeric(c(rep("0.8", times = 8)))
  )

# plot hypothesis data by background, generation, and treatment
jpeg("figures/ha_memory.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(ha_memory, aes(x = larval_generation, y = mean, group = background)) + 
  geom_line(aes(color = background), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = background, fill = background), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Background", color = "Background") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

#### 1b: Simulate data and visualize null (H<sub>n</sub>) and alternative (H<sub>a</sub>) hypotheses for phenotypic response analysis.
Here, we generate data tables to simulate expected patterns in phenotpyic response assuming the null hypothesis (i.e., that any phenotypic difference between control and insecticide-treated individuals with a background of insecticide exposure in the F0 generation will be maintained over successive generations) and alternative hypothesis (i.e., that any phenotypic difference between control and insecticide-treated exposed F0 individuals will vary across generations).

##### 1b.1. Simulate and visualize data for H<sub>n</sub>; run the Rmd chunk below.

##### Simulate data and generate figure for H<sub>n</sub>: `figures/hn_response.jpeg`
```{r}
# generate test data for null hypothesis
hn_response <- tibble(
  larval_generation = c(rep("F0", times = 2),
                        rep("F1", times = 2), 
                        rep("F2", times = 2), 
                        rep("F3", times = 2)),
  background = c(rep("E", times = 8)),
  treatment = c(rep(c("C","E"), times = 4)),
  mean = as.numeric(c(rep(c("10","5"), times = 4))),
  se = as.numeric(c(rep("0.8", times = 8)))
  )

# plot hypothesis data by background, generation, and treatment
jpeg("figures/hn_response.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(hn_response, aes(x = larval_generation, y = mean, group = treatment)) + 
  geom_line(aes(color = treatment), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = treatment), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = treatment, fill = treatment), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Treatment", color = "Treatment") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

##### 1b.2. Simulate and visualize data for H<sub>a</sub>; run the Rmd chunk below.

##### Simulate data and generate figure for H<sub>a</sub>: `figures/ha_response.jpeg`
```{r}
# generate test dataset for alternative hypothesis
ha_response <- tibble(
  larval_generation = c(rep("F0", times = 2),
                        rep("F1", times = 2), 
                        rep("F2", times = 2), 
                        rep("F3", times = 2)),
  background = c(rep("E", times = 8)),
  treatment = c(rep(c("C","E"), times = 4)),
  mean = as.numeric(c(rep("10", times = 1),
           rep("5", times = 1),
           rep(c("10","14"), times = 3))),
  se = as.numeric(c(rep("0.8", times = 8))),
  )

# plot hypothesis data by background, generation, and treatment
jpeg("figures/ha_response.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(ha_response, aes(x = larval_generation, y = mean, group = treatment)) + 
  geom_line(aes(color = treatment), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = treatment), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = treatment, fill = treatment), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Treatment", color = "Treatment") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

### STEP 2: Test fit of empirical data to a normal distribution; run the Rmd chunk below.
In this step, we use the shapiro-wilk test to assess whether total distance walked among larvae in each group of interest deviates from a normal distribution.

##### Test fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# test for fit of normality with treatments and generations and compare to alpha of 0.05/14 = 0.003 (to account for multiple comparisons)
mobility %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(total_distance) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.001 </b><br>
<b>F0_C_E: p < 0.001 </b><br>
<b>F1_C_C: p = 0.002 </b><br>
<b>F1_C_E: p = 0.011 </b><br>
<b>F1_E_C: p < 0.001 </b><br>
<b>F1_E_E: p < 0.001 </b><br>
<b>F2_C_C: p = 0.633 </b><br>
<b>F2_C_E: p = 0.015 </b><br>
<b>F2_E_C: p = 0.108 </b><br>
<b>F2_E_E: p = 0.190 </b><br>
<b>F3_C_C: p = 0.001 </b><br>
<b>F3_C_E: p = 0.017 </b><br>
<b>F3_E_C: p = 0.047 </b><br>
<b>F3_E_E: p < 0.001 </b><br>

Since 7/14 tests for normality fit indicate a deviation from a normal distribution, we apply a square-root transformation to the raw data to prepare for analysis.

### STEP 3: Square-root transform total distance walked data and re-assess fit of normal distribution; run the Rmd chunk below.
In this step, we calculate the square root of the raw total distance data and re-assess the fit of the transformed data to a normal distribution.

##### Transform data and re-assess fit of normality:
```{r}
# load mobility data
load("data/mobility.Rda")

# set to show decimals rather than scientific notation for p-value assessments
options(scipen = 999)

# square root transform total distance data and modify dataset
distance <- mobility %>%
  mutate(sqrt_distance = sqrt(total_distance))

# re-assess fit of normality to square-root-transformed data (based on p-value correction for multiple tests)
distance %>%
  group_by(larval_generation, background, treatment) %>%
  shapiro_test(sqrt_distance) %>%
  mutate(alpha = 0.003) %>%
  mutate(deviates = ifelse(p < alpha, "yes", "no"))

# save transformed distance mobility data
save(distance, file = "data/distance.Rda")
```

<b>Analysis results:</b> <br>

<b>Shapiro-wilk p-values for each treatment and generation:</b><br>
<b>F0_C_C: p < 0.434 </b><br>
<b>F0_C_E: p < 0.009 </b><br>
<b>F1_C_C: p = 0.422 </b><br>
<b>F1_C_E: p = 0.516 </b><br>
<b>F1_E_C: p < 0.235 </b><br>
<b>F1_E_E: p < 0.014 </b><br>
<b>F2_C_C: p = 0.489 </b><br>
<b>F2_C_E: p = 0.366 </b><br>
<b>F2_E_C: p = 0.659 </b><br>
<b>F2_E_E: p = 0.074 </b><br>
<b>F3_C_C: p = 0.133 </b><br>
<b>F3_C_E: p = 0.587 </b><br>
<b>F3_E_C: p = 0.337 </b><br>
<b>F3_E_E: p < 0.271 </b><br>

All 14 tests indicate fit of the normal distribution, so we continue with analysis using these transformed data.

### STEP 4: Assess phenotypic memory of insecticide stress in total distance walked.

#### 4a: Run linear mixed effect model to test the effect of insecticide stress on phenotypic memory in total distance walked; run the Rmd chunk below.

##### Run linear model for phenotypic memory of insecticide stress in total distance walked:
```{r}
# load distance mobility data
load("data/distance.Rda")

# get only individuals given the control in each generation (for both background exposure groups)
distance <- distance %>%
  filter(treatment == "C")

# get only F0 individuals
f0 <- distance %>%
  filter(larval_generation == "F0")

# get only F1 individuals
f1 <- distance %>%
  filter(larval_generation == "F1")

# get only F2 individuals
f2 <- distance %>%
  filter(larval_generation == "F2")

# get only F3 individuals
f3 <- distance %>%
  filter(larval_generation == "F3")

# run linear mixed effect model for F0
f0_model <- lmer(sqrt_distance ~ background + (1|lineage),
             data = f0)

# run linear mixed effect model for F1
f1_model <- lmer(sqrt_distance ~ background + (1|lineage),
             data = f1)

# run linear mixed effect model for F2
f2_model <- lmer(sqrt_distance ~ background + (1|lineage),
             data = f2)

# run linear mixed effect model for F3
f3_model <- lmer(sqrt_distance ~ background + (1|lineage),
             data = f3)

# set scipen to remove scientific notation
options(scipen = 999)

# summarize F0 model
Anova(f0_model)

# summarize F1model
Anova(f1_model)

# summarize F2 model
Anova(f2_model)

# summarize F3 model
Anova(f3_model)
```

#### 4b: Plot transformed data for total distance walked to visualize phenotypic memory; run the Rmd chunk below.

##### Plot transformed data for phenotypic memory analysis: `figures/distance_memory.jpeg`
```{r}
# load distance mobility data
load("data/distance.Rda")

# get only individuals given the control in each generation (for both background exposure groups)
distance <- distance %>%
  filter(treatment == "C")

# calculate means, standard deviation, and standard error of square-root transformed data 
distance <- distance %>%
  group_by(larval_generation, background) %>%
  summarize(mean = mean(sqrt_distance),
            sd = sd(sqrt_distance),
            n = n(),
            se = sd/sqrt(n))

# plot transformed data by background, generation, and treatment
jpeg("figures/distance_memory.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(distance, aes(x = larval_generation, y = mean, group = background)) + 
  geom_line(aes(color = background), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = background), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = background, fill = background), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Background", color = "Background") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

### STEP 5: Assess phenotypic response to insecticide stress in total distance walked.

#### 5a: Run linear mixed effect model to test the effect of insecticide stress on phenotypic memory in total distance walked; run the Rmd chunk below.

##### Assess phenotypic response to insecticide stress in total distance walked:
```{r}

```

#### 5b: Plot transformed data for total distance walked to visualize phenotypic response; run the Rmd chunk below.

##### Plot transformed data for phenotypic response analysis (with an exposure background): `figures/distance_response.jpeg`
```{r}
# load distance mobility data
load("data/distance.Rda")

# calculate means, standard deviation, and standard error of square-root transformed data 
distance <- distance %>%
  group_by(larval_generation, background, treatment) %>%
  summarize(mean = mean(sqrt_distance),
            sd = sd(sqrt_distance),
            n = n(),
            se = sd/sqrt(n))

# Convert background to "E" for both F0 groups and change treatment to C and E for each group, respectively
distance <- distance
distance$background[1] <- "E" 
distance$treatment[2] <- "E"

# get only individuals with the exposed background
distance <- distance %>%
  filter(background == "E")

# plot transformed data by background, generation, and treatment for exposed background
jpeg("figures/distance_response.jpeg", width = 10000, height = 8000, res = 700)
 
ggplot(distance, aes(x = larval_generation, y = mean, group = treatment)) + 
  geom_line(aes(color = treatment), linewidth = 2) + 
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, color = treatment), position = position_dodge(width = 0.1), width = 0.2, linewidth = 2) +
  geom_point(aes(x = larval_generation, y = mean, group = treatment, fill = treatment), position = position_dodge(width = 0.1), size = 5, pch = 22, stroke = 2, color = "black") +
  theme_set(theme_cowplot(12)) +
  scale_color_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_fill_manual(values = c("deepskyblue2", "firebrick3")) +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 3)) +
  ylim(0,15) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1)) + 
  theme(axis.text = element_text(size = 30, hjust = 0.4)) + 
  theme(axis.title = element_text(size = 40, hjust = 0.5)) + 
  theme(axis.title.y = element_text(vjust = +3)) + 
  theme(axis.title.x = element_text(vjust = -0.5)) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(legend.position = c(0.05,0.87)) + 
  theme(legend.text = element_text(size = 30)) +
  theme(legend.title = element_text(size = 30, face = "bold")) +
  theme(legend.key.size = unit(2, 'cm')) +
  theme(legend.key.spacing.y = unit(-0.5, 'cm')) +
  theme(legend.box.background = element_rect(color = "black", size = 1.5)) +
  theme(legend.box.margin = margin(5, 10, 1, 10)) +
  labs(x = "Larval generation", y = expression(sqrt("distance (mm)")), fill = "Treatment", color = "Treatment") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 2)) +
  theme(plot.margin = margin(20,20,20,20))

dev.off()
```

